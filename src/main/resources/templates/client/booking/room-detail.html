<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <title>usersearch</title>

  <style>
    html, body {
      height: 100% !important;
    }

    /* 默認情況下隱藏遮罩層 */
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.5);
      /* 半透明暗色效果 */
      backdrop-filter: blur(5px);
      /* 模糊效果 */
      z-index: 998;
      /* 高於其他元素但低於下拉選單 */
      display: none;
      /* 初始狀態隱藏 */
    }

    #date {
      label {
        cursor: pointer;
      }

      input {
        cursor: pointer;
      }
    }

    .border-box {
      box-sizing: border-box !important;
    }

    .border-radius-22px {
      border-radius: 22px;
    }

    .border-bottom-dashed {
      border-bottom: 1px dashed black !important;
    }

    .border-bottom-gray {
      border-bottom: 1px solid #ccc !important;
    }

    .border-bottom-gray-2 {
      border-bottom: 2px solid #ccc !important;
    }

    .max-w-90 {
      max-width: 90%;
    }

    .w-90 {
      width: 90%;
    }

    .w-80 {
      width: 80%;
    }

    .w-70 {
      width: 70%;
    }

    .w-35 {
      width: 35%;
    }

    .w-30 {
      width: 30%;
    }

    .w-20 {
      width: 20%;
    }

    .w-15 {
      width: 15%;
    }

    .max-width-1200px {
      max-width: 1200px;
    }

    .w-240px {
      width: 240px;
    }

    .w-100px {
      width: 100px;
    }

    .w-80px {
      width: 80px;
    }

    .w-40px {
      width: 40px;
    }

    .h-80 {
      height: 80%;
    }

    .h-12d5px {
      height: 12.5px;
    }

    .h-25px {
      height: 25px;
    }

    .h-30px {
      height: 30px;
    }
    
    .h-40px {
      height: 40px;
    }

    .h-50px {
      height: 50px;
    }

    .h-60px {
      height: 60px;
    }

    .h-70px {
      height: 70px;
    }

    .h-80px {
      height: 80px;
    }

    .font-size-12px {
      font-size: 12px;
    }

    .font-size-25px {
      font-size: 25px;
    }

    .border-left-gray {
      border-left: 1px solid #ccc;
    }

    /* 取消默認的外框 */
    .form-control {
      border: none !important;         /* 移除边框 */
      box-shadow: none !important;     /* 移除阴影 */
    }

    /* 調整輸入下拉框的位置 */
    .drop-menu-search {
      transform: translate(0, 66px) !important; /* X軸和Y軸的位移調整 */
    }

    /* 調整輸入下拉框的位置 */
    .drop-people-number-search {
      transform: translate(0, 66px) !important;
    }

    .footer-bgc {
      background-color: rgb(42, 42, 46);
    }

    .flex-grow-2 {
      flex-grow: 2;
    }

    .flex-grow-3 {
      flex-grow: 3;
    }

    .flex-grow-4 {
      flex-grow: 4;
    }

    .outline-0 {
      outline: none;
    }

    .outline-1 {
      outline: 1px solid black;
    }

    .card {
      cursor: pointer;
      transition: box-shadow 0.2s ease; /* 添加動畫過渡效果 */
    }

    .card:hover {
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2), 0 3px 20px rgba(95, 95, 95, 0.147); /* hover時的陰影效果 */
    }

    .card-bgc {
      background-color: #f5f8ff;
    }

    .card-bgc:hover {
      background-color: white;
    }

    .cursor-pointer {
      cursor: pointer;
    }

    #banner {
      width: 100%;
    }

    #search-room {
      position: relative;
      z-index: 999;
    }

    #search {
      cursor: pointer;

      label {
        cursor: pointer
      }

      input {
        cursor: pointer;
      }
    }

    /* 專屬於某個標籤的特定class */
    .theme-instastay {
      background-color: #20274d;
    }

    .room-detail-largeimg-radius {
      border-radius: 22px 0.375rem 0.375rem 22px;
    }

    .room-detail-littleimg-radius1 {
      border-radius: 0.375rem 22px 0.375rem 0.375rem;
    }

    .room-detail-littleimg-radius2 {
      border-radius: 0.375rem 0.375rem 22px 0.375rem;
    }

    .w-search-input {
      width: calc(171.428571428% + 8px);
    }
    .w-search-date-input {
      width: calc(50% + 16px)
    }

    .search-btn-bgc {
      background-color: #5392f9;
      transition: .2s;
    }

    .search-btn-bgc:hover {
      background-color: #5393f9ba;
    }

    .search-key-bgc {
      background-color: #eff4fc !important;
    }

    .customer-col-md-3 {
      flex: 0 0 auto;
      width: calc(25% - 1rem);
    }

    .custom-box-shadow {
      box-shadow: 0px 2px 7px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body>
  <div th:replace="~{client/common/header}"></div>

  <main>
	<div th:replace="~{client/booking/room-search-input}"></div>
    <section class="container-fluid p-0 max-width-1200px w-100 mb-3">
      <div class="row m-0 cursor-pointer" data-bs-toggle="modal" data-bs-target="#imgGroup" style="height: 375px !important">
        <div class="col-md-5 p-0 h-100">
          <img th:src="@{/management/roomtype/image/{id}(id=${roomtype.roomtypeId})}" class="w-100 h-100 object-fit-cover room-detail-largeimg-radius" alt="room">
        </div>
        <div class="col-md-7 p-0">
          <div class="row m-0 text-center h-100">
            <div class="col-md-4 pe-0 ps-2 pb-2"><img th:src="${'https://bookingdb.s3.ap-east-1.amazonaws.com/booking/roomtype' + roomtype.roomtypeId + '/room1'}" class="w-100 h-100 rounded" alt=""></div>
            <div class="col-md-4 pe-0 ps-2 pb-2"><img th:src="${'https://bookingdb.s3.ap-east-1.amazonaws.com/booking/roomtype' + roomtype.roomtypeId + '/room2'}" class="w-100 h-100 rounded" alt=""></div>
            <div class="col-md-4 pe-0 ps-2 pb-2"><img th:src="${'https://bookingdb.s3.ap-east-1.amazonaws.com/booking/roomtype' + roomtype.roomtypeId + '/room3'}" class="w-100 h-100 room-detail-littleimg-radius1" alt=""></div>
            <div class="col-md-4 pe-0 ps-2"><img th:src="${'https://bookingdb.s3.ap-east-1.amazonaws.com/booking/roomtype' + roomtype.roomtypeId + '/room4'}" class="w-100 h-100 rounded" alt=""></div>
            <div class="col-md-4 pe-0 ps-2"><img th:src="${'https://bookingdb.s3.ap-east-1.amazonaws.com/booking/roomtype' + roomtype.roomtypeId + '/room5'}" class="w-100 h-100 rounded" alt=""></div>
            <div class="col-md-4 pe-0 ps-2"><img th:src="${'https://bookingdb.s3.ap-east-1.amazonaws.com/booking/roomtype' + roomtype.roomtypeId + '/room6'}" class="w-100 h-100 room-detail-littleimg-radius2" alt=""></div>        
          </div>
        </div>
        <div class="modal fade" id="imgGroup" tabindex="-1" aria-labelledby="imgGroup" aria-hidden="true">
          <div class="modal-dialog max-w-90">
            <div class="modal-content">
              <div class="modal-header custom-box-shadow">
                <span class="d-block text-primary link-underline link-underline-opacity-0"
                  style="font-size: 13px; font-weight: bold;">所有照片 ( 9張 )</span>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-4 p-2">
                    <img th:src="@{/management/roomtype/image/{id}(id=${roomtype.roomtypeId})}" class="w-100 rounded custom-box-shadow" alt="room1">
                  </div>
                  <div class="col-md-4 p-2">
                    <img th:src="${'https://bookingdb.s3.ap-east-1.amazonaws.com/booking/roomtype' + roomtype.roomtypeId + '/room1'}" class="w-100 rounded custom-box-shadow" alt="room1">
                  </div>
                  <div class="col-md-4 p-2">
                    <img th:src="${'https://bookingdb.s3.ap-east-1.amazonaws.com/booking/roomtype' + roomtype.roomtypeId + '/room2'}" class="w-100 rounded custom-box-shadow" alt="room1">
                  </div>
                  <div class="col-md-4 p-2">
                    <img th:src="${'https://bookingdb.s3.ap-east-1.amazonaws.com/booking/roomtype' + roomtype.roomtypeId + '/room3'}" class="w-100 rounded custom-box-shadow" alt="room1">
                  </div>
                  <div class="col-md-4 p-2">
                    <img th:src="${'https://bookingdb.s3.ap-east-1.amazonaws.com/booking/roomtype' + roomtype.roomtypeId + '/room4'}" class="w-100 rounded custom-box-shadow" alt="room1">
                  </div>
                  <div class="col-md-4 p-2">
                    <img th:src="${'https://bookingdb.s3.ap-east-1.amazonaws.com/booking/roomtype' + roomtype.roomtypeId + '/room5'}" class="w-100 rounded custom-box-shadow" alt="room1">
                  </div>
                  <div class="col-md-4 p-2">
                    <img th:src="${'https://bookingdb.s3.ap-east-1.amazonaws.com/booking/roomtype' + roomtype.roomtypeId + '/room6'}" class="w-100 rounded custom-box-shadow" alt="room1">
                  </div>
                  <div class="col-md-4 p-2">
                    <img th:src="${'https://bookingdb.s3.ap-east-1.amazonaws.com/booking/roomtype' + roomtype.roomtypeId + '/room3'}" class="w-100 rounded custom-box-shadow" alt="room1">
                  </div>
                  <div class="col-md-4 p-2">
                    <img th:src="${'https://bookingdb.s3.ap-east-1.amazonaws.com/booking/roomtype' + roomtype.roomtypeId + '/room5'}" class="w-100 rounded custom-box-shadow" alt="room1">
                  </div>
                </div>
              </div>
              <div class="modal-footer custom-box-shadow">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </section>
    <section class="container-fluid p-0 max-width-1200px w-100">
      <header class="mb-3">
        <div class="row m-0 h-70px border rounded align-items-center">
          <div class="col-md-8 p-0">
            <div class="row m-0 text-center h-100">
              <div class="col-md p-0 border-end"><a href="#" class="nav-link">簡介</a></div>
              <div class="col-md p-0 border-end"><a href="#" class="nav-link">房型</a></div>
              <div class="col-md p-0 border-end"><a href="#" class="nav-link">活動</a></div>
              <div class="col-md p-0 border-end"><a href="#" class="nav-link">服務</a></div>
              <div class="col-md p-0 border-end"><a href="#" class="nav-link">地點</a></div>
              <div class="col-md p-0 border-end"><a href="#" class="nav-link">政策</a></div>
            </div>
          </div>
          <div class="col-md-4 p-0 d-flex align-items-center justify-content-end">
            <span class="fs-4 text-danger me-3"><small style="font-size: 14px;">NT$</small><span th:text="${roomtype.roomtypePrice}"></span></span>
            <button class="btn btn-primary border-radius-22px fw-bolder me-3">立即預定</button>
          </div>
        </div>
      </header>
      <article class="row m-0">    
        <div class="col-md-9 p-0">
          <!-- 房間簡介 -->
          <div class="mb-3 p-3 border rounded">
            <div class="mb-2"><img th:src="@{/client/booking/image/homes-logo.svg}" width="25" alt="homes-logo"></div>
            <h3 class="fs-4 fw-bolder mb-0" th:text="${roomtype.roomtypeName}"></h3>
            <div><a href="#" class="small link-underline link-underline-opacity-0" th:text="${roomtype.roomtypeDistrict + ', ' + roomtype.roomtypeCity + ', 台灣 - 查看地圖&週邊景點'}"></a></div>
            <hr>
            <p class="small mb-0" th:text="${roomtype.roomtypeDescription}"></p>
          </div>
          <!-- 重點服務 -->
          <div class="mb-3 p-3 border rounded">
            <div class="mb-2"><img th:src="@{/client/booking/image/service-logo.jpg}" class="object-fit-cover" width="30" height="30" alt="homes-logo"></div>
            <h3 class="fs-4 fw-bolder">重點服務</h3>
            <div class="row m-0">
              <div th:each="amenity : ${roomtype.amenities}" class="col-md-3 p-0">
                <i class="bi bi-check-lg me-1 fs-5 align-middle"></i>
                <small th:text="${amenity.name}"></small>
              </div>
            </div>
          </div>
          <!-- 空間、房間 -->
          <div class="mb-3 p-3 border rounded">
            <div class="mb-2"><img th:src="@{/client/booking/image/bed-icon.jpg}" class="object-fit-cover" width="30" height="30" alt="homes-logo"></div>
            <h3 class="fs-4 fw-bolder mb-3">空間與房間</h3>
            <hr>
     
            <div>民宿 <small class="font-size-12px">(客房面積：33平方公尺/355平方英尺)</small></div>
          
            <div class="d-flex mb-3">
              <small class="border-end ps-0 px-2 font-size-12px" th:text="${'最多限住' + roomtype.roomtypeCapacity + '人'}">最多限住3人</small>
              <small class="border-end px-2 font-size-12px">單室套房/單臥室</small>
              <small class="px-2 font-size-12px">1間衛浴</small>
            </div>

            <div class="d-flex">
              <div class="border p-3 rounded-3 me-3 w-240px">
                <span class="d-block small">臥室床型 : </span>
                <small class="font-size-12px"><span th:text="${roomtype.roomtypeCapacity}"></span>張雙人床</small>
                <div class="mt-2">  
                  <img th:src="@{/client/booking/image/bed-icon2.png}" width="20" alt="hairdryer">
                </div>
              </div>
              <div class="border p-3 rounded-3 w-240px">
                <span class="d-block small">衛浴設備 : </span>
                <small class="font-size-12px">吹風機，浴巾，盥洗用品</small>
                <div class="mt-2">  
                  <img th:src="@{/client/booking/image/hairdryer-icon.png}" width="20" alt="hairdryer">
                  <img class="mx-2" th:src="@{/client/booking/image/towel-icon.png}" width="20" alt="towel">
                  <img th:src="@{/client/booking/image/toiletries-icon.png}" width="20" alt="toiletries">
                </div>
              </div>
            </div>
          </div> 
        </div>
        <aside class="customer-col-md-3 p-3 ms-3 mb-3 border rounded">
          <div class="w-100">
            <div id="map" class="w-100" style="width: 250px; height: 120px;"></div>
          </div>
          <hr>
          <div class="small">
            <span class="fw-bolder d-block my-2 text-danger">可步行抵達的地點</span>
            <div id="walkablePlaces"></div>
          </div>
          <div class="small">
            <span class="fw-bolder d-block my-2 text-danger">人氣景點</span>
            <div id="attractions"></div>
          </div>
          <div class="small">
            <span class="fw-bolder d-block my-2 text-danger">距離最近的景點</span>
            <div id="closestPlaces"></div>
          </div>
        </aside>
      </article>
    </section>
  </main>

  <div th:replace="~{client/common/footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=YOU_KEY&libraries=places&callback=initMap" async defer></script>

<script>
  // 儲存地點的數組
  let walkablePlacesArray = [];
  let attractionsArray = [];
  let closestPlacesArray = [];

  let map; // 將地圖變數移到外部範圍

  let walkablePlaces = document.getElementById('walkablePlaces');
  let attractions = document.getElementById('attractions');
  let closestPlaces = document.getElementById('closestPlaces');

  function renderLocation(dom, locations) {
    locations.forEach(location => {
      let div = `<div class="d-flex align-items-center my-1"><img src="${location.icon}" class="me-1" style="width: 14px; height: 14px;"></img>${location.name.substring(0, 10)}<span class="ms-auto">${location.distance}</span></div>`;
      dom.innerHTML += div;
    });
  }

  function initMap() {
      const geocoder = new google.maps.Geocoder();
      const address = "[[${roomtype.roomtypeAddress}]]"; // 地址

      geocoder.geocode({ 'address': address }, (results, status) => {
          if (status === 'OK') {
              const centerLocation = results[0].geometry.location;
              map = new google.maps.Map(document.getElementById("map"), {
                  center: centerLocation,
                  zoom: 15,
              });

              // 在地址位置添加紅色標記
              const marker = new google.maps.Marker({
                  map: map,
                  position: centerLocation,
                  title: '你的位置',
                  icon: {
                      url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                  }
              });

              map.setCenter(centerLocation);
              findNearbyPlaces(map, centerLocation);
          } else {
              alert('Geocode was not successful for the following reason: ' + status);
          }
      });
  }

  function findNearbyPlaces(map, centerLocation) {
    const service = new google.maps.places.PlacesService(map);

    // 可步行的地點請求，範圍設為1公里
    const walkableRequest = {
        location: centerLocation,
        radius: 1000, // 1公里
        type: ['store', 'restaurant', 'cafe', 'supermarket']
    };

    // 人氣景點請求，範圍設為5公里
    const attractionRequest = {
        location: centerLocation,
        radius: 5000, // 5公里
        type: ['tourist_attraction', 'park', 'museum']
    };

    // 執行搜索：可步行抵達的地點
    service.nearbySearch(walkableRequest, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
            processPlaces(results, centerLocation, 'walkable');
        }
    });

    // 執行搜索：人氣景點
    service.nearbySearch(attractionRequest, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
            processPlaces(results, centerLocation, 'attractions');
        }
    });
}

// 檢查地點是否合法
function isValidPlace(place) {
    const validTypes = [
        'restaurant', 
        'cafe', 
        'supermarket', 
        'tourist_attraction', 
        'park', 
        'museum', 
        'point_of_interest' // 添加其他有效類型
    ];

    // 檢查地點類型是否在有效類型中
    const isValidType = place.types.some(type => validTypes.includes(type));
    
    // 檢查是否不屬於城市或地區
    const isNotCity = !place.types.includes('locality') && !place.types.includes('administrative_area_level_1');

    return isValidType && isNotCity; // 確保是有效地點並不屬於城市
  }

function processPlaces(places, centerLocation, type) {
    console.log("processPlaces 被調用"); // 調試輸出
    const distanceService = new google.maps.DistanceMatrixService();
    const destinations = places.map(place => place.geometry.location);

    distanceService.getDistanceMatrix({
        origins: [centerLocation],
        destinations: destinations,
        travelMode: 'WALKING'
    }, (response, status) => {
        if (status === 'OK') {
            const distances = response.rows[0].elements;

            for (let i = 0; i < places.length; i++) {
                const place = places[i];
                const distanceValue = distances[i].distance.value;

                // 過濾距離，根據類型進行篩選
                if (type === 'walkable' && distanceValue <= 1000 && isValidPlace(place)) {
                    const placeInfo = {
                        name: place.name,
                        location: place.geometry.location,
                        address: place.vicinity,
                        distance: distances[i].distance.text,
                        distanceValue: distanceValue,
                        icon: place.icon
                    };

                    // 檢查是否已經存在於可步行地點陣列中
                    const isDuplicate = walkablePlacesArray.some(existingPlace => existingPlace.name === placeInfo.name && existingPlace.distanceValue === placeInfo.distanceValue);

                    if (!isDuplicate) {
                        walkablePlacesArray.push(placeInfo);
                        createMarker(map, placeInfo);
                    }
                } else if (type === 'attractions' && distanceValue <= 5000 && isValidPlace(place)) { // 僅對人氣景點進行5公里範圍的檢查
                    const placeInfo = {
                        name: place.name,
                        location: place.geometry.location,
                        address: place.vicinity,
                        distance: distances[i].distance.text,
                        distanceValue: distanceValue,
                        icon: place.icon
                    };

                    // 檢查是否已經存在於人氣景點陣列中
                    const isDuplicate = attractionsArray.some(existingPlace => existingPlace.name === placeInfo.name && existingPlace.distanceValue === placeInfo.distanceValue);

                    if (!isDuplicate) {
                        attractionsArray.push(placeInfo);
                        createMarker(map, placeInfo);
                    }
                }
            }

            // 根據類型進行輸出和排序
            if (type === 'walkable') {
                console.log("可步行抵達的地點數量:", walkablePlacesArray.length);
                if (walkablePlacesArray.length > 0) {
                    walkablePlacesArray.sort((a, b) => a.distanceValue - b.distanceValue);
                    renderLocation(walkablePlaces, walkablePlacesArray);
                    console.log('可步行抵達的地點排序:', walkablePlacesArray);
                }
            } else if (type === 'attractions') {
                console.log("人氣景點數量:", attractionsArray.length);
                if (attractionsArray.length > 0) {
                    attractionsArray.sort((a, b) => a.distanceValue - b.distanceValue);
                    renderLocation(attractions, attractionsArray);
                    console.log('人氣景點排序:', attractionsArray);
                    renderLocation(closestPlaces, attractionsArray.slice(0, 5));
                }
            }
        }
    });
}


  // 創建標記並顯示在地圖上
  function createMarker(map, placeInfo) {
      const marker = new google.maps.Marker({
          map: map,
          position: placeInfo.location,
          icon: {
              url: placeInfo.icon,
              scaledSize: new google.maps.Size(30, 30)
          }
      });

      // 創建 InfoWindow
      const infoWindow = new google.maps.InfoWindow();

      // 使用閉包保存當前的 placeInfo
      google.maps.event.addListener(marker, 'click', () => {
          // 設置 InfoWindow 的內容
          infoWindow.setContent(`<div><strong>${placeInfo.name}</strong><br>距離: ${placeInfo.distance}</div>`);
          infoWindow.open(map, marker); // 在標記位置打開 InfoWindow
      });
  }
  
</script>
</body>
</html>